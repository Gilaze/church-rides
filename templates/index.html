{% extends "layout.html" %}

{% block content %}
<div class="text-center mb-4">
    <h2>Online Transportation System</h2>
    <p class="text-muted mb-1">Address: To Be Determined</p>
    <p class="text-muted" id="date-display" style="font-size: 0.9rem;"></p>
</div>

<!-- Account Actions - Hidden on mobile (shown after transportation list) -->
<div class="account-actions-desktop">
    {% if current_user.is_authenticated %}
    <div class="mb-4 d-flex justify-content-between align-items-center">
        <div class="d-flex gap-2">
            {% if current_user.is_driver %}
                <form method="POST" action="/downgrade_to_passenger" style="display: inline;">
                    <button type="submit" class="btn btn-danger"
                            onclick="return confirm('Are you sure? This will remove your Pickup Location and all its passengers.')">
                        Can't Drive
                    </button>
                </form>
                <a href="/add_vehicle" class="btn btn-success">+ Add My Pickup Location</a>
            {% else %}
                <a href="/upgrade_to_driver" class="btn btn-outline-primary">Become a Driver</a>
            {% endif %}

            {% if current_user.is_admin %}
                <a href="/admin_dashboard" class="btn btn-warning">Admin Dashboard</a>
                <form method="POST" action="/demote_admin" style="display: inline;">
                    <button type="submit" class="btn btn-outline-secondary"
                            onclick="return confirm('Are you sure you want to remove admin privileges?')">
                        Demote Admin
                    </button>
                </form>
            {% endif %}
        </div>
        {% if current_user.is_admin %}
            <span class="badge bg-danger fs-6">ADMIN</span>
        {% endif %}
    </div>
    {% else %}
    <div class="alert alert-info mb-4">
        <strong>Welcome!</strong> Please <a href="/login" class="alert-link">login</a> or <a href="/register" class="alert-link">register</a> to join a ride or become a driver.
    </div>
    {% endif %}
</div>

<!-- Check if user is already in a vehicle -->
{% set user_current_vehicle = none %}
{% if current_user.is_authenticated %}
    {% for car in vehicles %}
        {% for person in car.passengers %}
            {% if person.id == current_user.id %}
                {% set user_current_vehicle = car.id %}
            {% endif %}
        {% endfor %}
    {% endfor %}
{% endif %}

<div class="row row-cols-1 row-cols-md-3 g-4">
    {% for car in vehicles %}
    <div class="col">
        <div class="vehicle-card {% if car.is_full %}full-capacity{% endif %}">
            <div class="driver-header d-flex justify-content-between align-items-start">
                <div>
                    <h5>{{ car.name }}</h5>
                    <small>Driver: {{ car.driver }}</small><br>
                    <small class="text-muted">Phone: {{ car.driver_phone }}</small><br>
                    <small class="text-muted">Driver Capacity: {{ car.driver_total_passengers }} / {{ car.driver_capacity }}</small>
                </div>
                {% if current_user.is_authenticated and (car.driver_id == current_user.id or current_user.is_admin) %}
                    <a href="/remove_vehicle/{{ car.id }}" class="btn btn-sm btn-outline-danger"
                       onclick="return confirm('Are you sure you want to remove this Pickup Location?')">
                        ✕
                    </a>
                {% endif %}
            </div>

            <ul class="list-group list-group-flush mt-3 mb-3">
                {% for person in car.passengers %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span>
                            {{ person.full_name }}
                            {% if current_user.is_authenticated and person.id == current_user.id %}
                                <span class="badge bg-success">YOU</span>
                            {% endif %}
                        </span>
                        {% if current_user.is_authenticated and (current_user.is_admin or person.id == current_user.id) %}
                            <a href="/remove_passenger/{{ car.id }}/{{ person.id }}"
                               class="btn btn-sm btn-danger"
                               style="width: 25px; height: 25px; padding: 0; line-height: 23px;">
                                ✕
                            </a>
                        {% endif %}
                    </li>
                {% endfor %}
            </ul>

            <!-- Button logic for passengers -->
            {% set in_this_car = false %}
            {% for person in car.passengers %}
                {% if person.id == current_user.id %}
                    {% set in_this_car = true %}
                {% endif %}
            {% endfor %}

            {% if current_user.is_authenticated %}
                {% if user_current_vehicle == none and not car.is_full %}
                    <!-- User not in any vehicle - show +add button if space available -->
                    <a href="/join/{{ car.id }}" class="btn btn-primary w-100">+ Add</a>
                {% elif user_current_vehicle == car.id %}
                    <!-- User is in this vehicle - show remove button (handled above in passenger list) -->
                {% elif car.is_full %}
                    <button class="btn btn-secondary w-100" disabled>Full</button>
                {% else %}
                    <!-- User is in another vehicle - don't show button -->
                    <button class="btn btn-secondary w-100" disabled>Already Booked</button>
                {% endif %}
            {% else %}
                <!-- Guest user - show login prompt -->
                {% if car.is_full %}
                    <button class="btn btn-secondary w-100" disabled>Full</button>
                {% else %}
                    <a href="/login" class="btn btn-outline-primary w-100">Login to Join</a>
                {% endif %}
            {% endif %}
        </div>
    </div>
    {% endfor %}

    {% if vehicles|length == 0 %}
        <div class="col-12 text-center">
            <p class="text-muted">No Pickup Locations available yet. Drivers can add their Pickup Location above.</p>
        </div>
    {% endif %}
</div>

<!-- Account Actions - Mobile only (shown after transportation list) -->
<div class="account-actions-mobile mt-4">
    {% if current_user.is_authenticated %}
    <div class="mb-4">
        <div class="d-flex flex-column gap-2">
            {% if current_user.is_driver %}
                <a href="/add_vehicle" class="btn btn-success">+ Add My Pickup Location</a>
                <form method="POST" action="/downgrade_to_passenger" style="display: inline;">
                    <button type="submit" class="btn btn-danger w-100"
                            onclick="return confirm('Are you sure? This will remove your Pickup Location and all its passengers.')">
                        Can't Drive
                    </button>
                </form>
            {% else %}
                <a href="/upgrade_to_driver" class="btn btn-outline-primary">Become a Driver</a>
            {% endif %}

            {% if current_user.is_admin %}
                <a href="/admin_dashboard" class="btn btn-warning">Admin Dashboard</a>
                <form method="POST" action="/demote_admin">
                    <button type="submit" class="btn btn-outline-secondary w-100"
                            onclick="return confirm('Are you sure you want to remove admin privileges?')">
                        Demote Admin
                    </button>
                </form>
            {% endif %}
        </div>
    </div>
    {% else %}
    <div class="alert alert-info mb-4">
        <strong>Welcome!</strong> Please <a href="/login" class="alert-link">login</a> or <a href="/register" class="alert-link">register</a> to join a ride or become a driver.
    </div>
    {% endif %}
</div>

<style>
    /* Desktop: show actions above, hide mobile actions */
    @media (min-width: 768px) {
        .account-actions-desktop { display: block; }
        .account-actions-mobile { display: none; }
    }

    /* Mobile: hide desktop actions, show mobile actions after list */
    @media (max-width: 767px) {
        .account-actions-desktop { display: none; }
        .account-actions-mobile { display: block; }
    }
</style>

<script>
    // Set today's date in headline
    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    document.getElementById("date-display").innerText = new Date().toLocaleDateString("en-US", options);

    // Auto-refresh page every 15 seconds
    setTimeout(function() {
        location.reload();
    }, 15000);
</script>
{% endblock %}