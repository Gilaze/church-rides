{% extends "layout.html" %}

{% block content %}
<div class="row justify-content-center mt-5">
    <div class="col-11 col-sm-10 col-md-8 col-lg-6">
        <div class="card shadow">
            <div class="card-header bg-primary text-white text-center py-4">
                <h4 class="mb-0">My Profile</h4>
            </div>
            <div class="card-body p-4">
                <form method="POST">
                    <div class="mb-3">
                        <label class="form-label">Full Name</label>
                        <input type="text" name="full_name" class="form-control" value="{{ current_user.full_name }}" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Username</label>
                        <input type="text" name="username" class="form-control" value="{{ user_data.username }}" required>
                        <small class="form-text text-muted">Changing username may affect your login</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Grade</label>
                        <input type="text" name="grade" class="form-control" value="{{ user_data.grade }}" placeholder="Freshman, Sophomore, Junior, Senior" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Residence</label>
                        <input type="text" name="residence" class="form-control" value="{{ user_data.residence }}" placeholder="City, State or Area" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Phone Number (optional)</label>
                        <input type="tel" name="phone_number" class="form-control" value="{{ user_data.phone_number }}" placeholder="(123) 456-7890">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email (optional)</label>
                        <input type="email" name="email" class="form-control" value="{{ user_data.email }}" placeholder="your.email@example.com">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Password</label>
                        <div class="input-group">
                            <input type="password" name="password" id="passwordField" class="form-control" placeholder="Leave blank to keep current password">
                            <button class="btn btn-outline-secondary" type="button" onclick="togglePassword()">
                                <span id="eyeIcon">üëÅÔ∏è</span>
                            </button>
                        </div>
                        <small class="form-text text-muted">Leave blank to keep your current password</small>
                    </div>

                    {% if current_user.is_driver %}
                    <div class="mb-3">
                        <label class="form-label">Your Max Passenger Capacity (total across all vehicles)</label>
                        <input type="number" name="driver_capacity" class="form-control" value="{{ user_data.driver_capacity }}" min="1" max="30" required>
                        <small class="form-text text-muted">This is the total number of passengers you can take across ALL your vehicles</small>
                    </div>

                    <hr>
                    <h5 class="mb-3">Your Vehicles</h5>
                    {% if vehicles_data %}
                        {% for vehicle in vehicles_data %}
                        <div class="card mb-3">
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">Vehicle Name</label>
                                    <input type="text" name="vehicle_name_{{ vehicle.id }}" class="form-control" value="{{ vehicle.vehicle_name }}" required>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" name="remember_vehicle_{{ vehicle.id }}" id="rememberVehicle{{ vehicle.id }}" {% if vehicle.remember_vehicle %}checked{% endif %}>
                                    <label class="form-check-label" for="rememberVehicle{{ vehicle.id }}">
                                        Remember Vehicle
                                    </label>
                                    <small class="form-text text-muted d-block">Keep this vehicle after the weekly Monday 12am reset</small>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="alert alert-info">
                            You haven't added any vehicles yet. <a href="/add_vehicle">Add a vehicle</a>
                        </div>
                    {% endif %}
                    {% endif %}

                    <button type="submit" class="btn btn-primary w-100 mb-3">Update Profile</button>
                </form>

                {% if not current_user.is_admin %}
                <hr>
                <div class="text-center">
                    <button type="button" class="btn btn-warning w-100 mb-3" onclick="toggleBecomeAdmin()">
                        Become Admin
                    </button>
                    <div id="becomeAdminField" style="display: none;">
                        <form method="POST" action="/become_admin">
                            <div class="mb-3">
                                <label class="form-label">Admin Password</label>
                                <input type="password" name="admin_password" class="form-control" placeholder="Enter admin password" required>
                                <small class="form-text text-muted">Enter the admin password to gain admin privileges</small>
                            </div>
                            <button type="submit" class="btn btn-success w-100 mb-3">Confirm</button>
                            <button type="button" class="btn btn-secondary w-100" onclick="toggleBecomeAdmin()">Cancel</button>
                        </form>
                    </div>
                </div>
                {% endif %}

                <hr class="my-4">
                <div class="danger-zone">
                    <h5 class="text-danger mb-3">Danger Zone</h5>
                    <p class="text-muted small mb-3">Once you delete your account, there is no going back. This action will:</p>
                    <ul class="text-muted small mb-3">
                        <li>Permanently delete your account and all personal information</li>
                        <li>Remove you from any assigned rides</li>
                        <li>Delete all your vehicles if you're a driver</li>
                        <li>Remove all passengers from your vehicles</li>
                    </ul>
                    <button type="button" class="btn btn-outline-danger w-100 mb-3" onclick="toggleDeleteAccount()">
                        Delete My Account
                    </button>
                    <div id="deleteAccountConfirm" style="display: none;">
                        <div class="alert alert-danger">
                            <strong>‚ö†Ô∏è Warning:</strong> This action cannot be undone!
                        </div>
                        <form method="POST" action="/delete_account">
                            <div class="mb-3">
                                <label class="form-label">Type your username to confirm: <strong>{{ user_data.username }}</strong></label>
                                <input type="text" name="confirm_username" class="form-control" placeholder="Enter your username" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Enter your password to confirm deletion</label>
                                <input type="password" name="confirm_password" class="form-control" placeholder="Enter your password" required>
                            </div>
                            <button type="submit" class="btn btn-danger w-100 mb-2">Yes, Permanently Delete My Account</button>
                            <button type="button" class="btn btn-secondary w-100" onclick="toggleDeleteAccount()">Cancel</button>
                        </form>
                    </div>
                </div>

                <div class="text-center mt-3">
                    <a href="/" class="btn btn-secondary w-100">Back to Home</a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function toggleBecomeAdmin() {
        const field = document.getElementById('becomeAdminField');
        field.style.display = field.style.display === 'none' ? 'block' : 'none';
    }

    function togglePassword() {
        const passwordField = document.getElementById('passwordField');
        const eyeIcon = document.getElementById('eyeIcon');

        if (passwordField.type === 'password') {
            passwordField.type = 'text';
            eyeIcon.textContent = 'üôà';
        } else {
            passwordField.type = 'password';
            eyeIcon.textContent = 'üëÅÔ∏è';
        }
    }

    function toggleDeleteAccount() {
        const field = document.getElementById('deleteAccountConfirm');
        field.style.display = field.style.display === 'none' ? 'block' : 'none';
    }
</script>
{% endblock %}
